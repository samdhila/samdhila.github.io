<!DOCTYPE html>
<html>
  <head>
    <title>Legal Document OCR System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" onerror="console.error('Failed to load opencv.js script!');"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuzzyset.js/0.0.2/fuzzyset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
      canvas {
        background-color: #f0f0f0;
        /* light grey color */
      }
    </style>
  </head>
  <body class="container mt-5">
    <div class="mb-4">
      <input type="file" class="form-control-file" id="inputImage" onchange="loadFile()" accept="image/*,application/pdf" disabled>
    </div>
    <div id="uploadLabel" class="mt-4 mb-5">Upload any PDF or image file to be scanned.</div>
    <div class="alert alert-info mt-3" role="alert" id="loadingIndicator" style="display: none;"> Currently recognizing... <div class="progress mt-2">
        <div class="progress-bar" role="progressbar" style="width: 0%;" id="ocrProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-4">
        <canvas id="canvasOriginal" class="img-fluid"></canvas>
      </div>
      <div class="col-md-4">
        <canvas id="canvasProcessed" class="img-fluid"></canvas>
      </div>
      <div class="col-md-4">
        <canvas id="canvasRecognized" class="img-fluid"></canvas>
      </div>
    </div>
    <h5 style="margin-top:30px;">RAW TEXT:</h5>
    <div id="rawText" class="mt-4 mb-5">The raw text from scanned document will be displayed here.</div>
    <script type="text/javascript">
      function onOpenCvReady() {
        $('#inputImage').prop('disabled', false);
      };
      let processedPages = 0; // Global variable to track the number of processed pages
      let totalPageCount = 0; // Global variable to track the total number of pages in the PDF
      function loadFile() {
        document.getElementById('rawText').innerText = "The raw text from scanned document will be displayed here.";
        $('#ocrProgress').css('width', '0%').attr('aria-valuenow', 0);
        let file = $('#inputImage')[0].files[0];
        if (file.type.match('image.*')) {
          loadImage(file);
        } else if (file.type === 'application/pdf') {
          loadPdf(file);
        }
      }

      function loadImage(file) {
        totalPageCount = 1; // Set totalPageCount to 1 for images
        processedPages = 0; // Reset processedPages
        let canvasOriginal = $('#canvasOriginal')[0];
        let ctxOriginal = canvasOriginal.getContext('2d');
        let imgOriginal = new Image();
        imgOriginal.onload = function() {
          canvasOriginal.width = imgOriginal.width;
          canvasOriginal.height = imgOriginal.height;
          ctxOriginal.drawImage(imgOriginal, 0, 0, imgOriginal.width, imgOriginal.height);
          // Call processImage with the original image data URL
          processImage(canvasOriginal.toDataURL('image/png'));
        };
        imgOriginal.src = URL.createObjectURL(file);
      }

      function loadPdf(file) {
        processedPages = 0; // Reset the processed pages counter
        let fileReader = new FileReader();
        fileReader.onload = function() {
          let typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(pdf => {
            totalPageCount = pdf.numPages;
            processPdfPage(pdf, 1); // Start processing from the first page
          });
        };
        fileReader.readAsArrayBuffer(file);
      }

      function processPdfPage(pdf, pageNum) {
        pdf.getPage(pageNum).then(page => {
          let viewport = page.getViewport({
            scale: 1
          });
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          page.render({
            canvasContext: ctx,
            viewport: viewport
          }).promise.then(() => {
            let imgProcessed = canvas.toDataURL('image/png');
            performOCR(imgProcessed, totalPageCount, (result) => {
              handleRawText(result);
              handleRecognizedText(imgProcessed, result);
              if (pageNum < totalPageCount) {
                // Process the next page
                processPdfPage(pdf, pageNum + 1);
              }
            });
          });
        });
      }

      function processImage(dataUrl) {
        let src = cv.imread('canvasOriginal');
        let dst = new cv.Mat();
        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
        cv.threshold(dst, dst, 127, 255, cv.THRESH_BINARY);
        cv.imshow('canvasProcessed', dst);
        // Convert the processed canvas to a Data URL
        let imgProcessed = $('#canvasProcessed')[0].toDataURL();
        // Now perform OCR on the processed image
        performOCR(imgProcessed, totalPageCount, (result) => {
          handleRawText(result);
          handleRecognizedText(imgProcessed, result);
        });
      }

      function performOCR(imgProcessed, totalPages, callback) {
        // Show the loading indicator and reset the progress bar
        $('#loadingIndicator').show();
        $('#ocrProgress').css('width', '0%').attr('aria-valuenow', 0);
        Tesseract.recognize(imgProcessed, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              // Update the progress bar
              let progressPercentage = Math.round(m.progress * 100);
              $('#ocrProgress').css('width', progressPercentage + '%').attr('aria-valuenow', progressPercentage);
            }
          }
        }).then(result => {
          if (typeof callback === "function") {
            callback(result);
          }
          // The logic to check for completion of all pages is now handled by processPdfPage
        }).catch(error => {
          console.error("Error during OCR processing:", error);
          resetLoadingIndicator('Error in text recognition');
          $('#loadingIndicator').addClass('alert-danger').removeClass('alert-info');
        });
      }

      function handleRawText({
        data: {
          text
        }
      }) {
        let existingText = document.getElementById('rawText').innerText;
        document.getElementById('rawText').innerText = existingText + "\n" + text;
        resetLoadingIndicator('Text recognized!');
        $('#loadingIndicator').addClass('alert-success').removeClass('alert-info');
      }
      // This function will handle the drawing of bounding boxes.
      function handleRecognizedText(imgProcessed, {
        data: {
          text,
          words
        }
      }) {
        drawBBox(words, imgProcessed);
      }

      function resetLoadingIndicator(message) {
        $('#loadingIndicator').contents().filter(function() {
          return this.nodeType === 3; // Node.TEXT_NODE
        }).remove();
        $('#loadingIndicator').prepend(message);
      }

      function drawBBox(words, imgProcessed) {
        let canvasRecognized = $('#canvasRecognized')[0];
        let boxOutline = canvasRecognized.getContext('2d');
        let imgRecognized = new Image();
        imgRecognized.onload = function() {
          canvasRecognized.width = imgRecognized.width;
          canvasRecognized.height = imgRecognized.height;
          boxOutline.drawImage(imgRecognized, 0, 0, imgRecognized.width, imgRecognized.height);
          words.forEach(word => {
            let bbox = word.bbox;
            boxOutline.beginPath();
            boxOutline.rect(bbox.x0, bbox.y0, bbox.x1 - bbox.x0, bbox.y1 - bbox.y0);
            boxOutline.lineWidth = 2;
            boxOutline.strokeStyle = 'red';
            boxOutline.fillStyle = 'red';
            boxOutline.stroke();
            boxOutline.fillText(word.text, bbox.x0, bbox.y0 > 10 ? bbox.y0 - 5 : 10);
          });
        };
        imgRecognized.src = imgProcessed;
      };
    </script>
  </body>
</html>
